/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JFrame.java to edit this template
 */
package klockimans;

import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.sql.SQLException;
import java.util.ArrayList;
import javax.swing.JOptionPane;
import javax.swing.JTextArea;

/**
 *
 * @author pfigat
 */
public class GUI extends javax.swing.JFrame {
    
    
  public static ArrayList <Klocek> globaltabKlocki = new ArrayList<>();
  private DatabaseManager dbManager;
  private AlgorithmResult lastResult;
    
    private static final java.util.logging.Logger logger = java.util.logging.Logger.getLogger(GUI.class.getName());

    /**
     * Creates new form GUI
     */
    public GUI() {
        initComponents();
        initializeDatabase();
    }
    
    private void initializeDatabase() {
        try {
            dbManager = new DatabaseManager();
            dbManager.createTableIfNotExists();
        } catch (SQLException e) {
            JOptionPane.showMessageDialog(this, 
                "B≈ÇƒÖd po≈ÇƒÖczenia z bazƒÖ danych: " + e.getMessage(),
                "B≈ÇƒÖd bazy danych", 
                JOptionPane.WARNING_MESSAGE);
        }
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jSplitPane1 = new javax.swing.JSplitPane();
        jPanel1 = new javax.swing.JPanel();
        jSplitPane2 = new javax.swing.JSplitPane();
        jPanel3 = new javax.swing.JPanel();
        jButton1 = new javax.swing.JButton();
        jButton2 = new javax.swing.JButton();
        jButton3 = new javax.swing.JButton();
        jButton4 = new javax.swing.JButton();
        jPanel4 = new javax.swing.JPanel();
        jPanel2 = new MyPanel();

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);

        jPanel1.setLayout(new java.awt.BorderLayout());

        jSplitPane2.setOrientation(javax.swing.JSplitPane.VERTICAL_SPLIT);

        jButton1.setText("Generowanie");
        jButton1.addActionListener(this::jButton1ActionPerformed);

        jButton2.setText("Uk≈Çadanie");
        jButton2.addActionListener(this::jButton2ActionPerformed);

        jButton3.setText("Zapis");
        jButton3.addActionListener(this::jButton3ActionPerformed);

        jButton4.setText("Odczyt");
        jButton4.addActionListener(this::jButton4ActionPerformed);

        javax.swing.GroupLayout jPanel3Layout = new javax.swing.GroupLayout(jPanel3);
        jPanel3.setLayout(jPanel3Layout);
        jPanel3Layout.setHorizontalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jButton1)
                    .addComponent(jButton2)
                    .addComponent(jButton3)
                    .addComponent(jButton4))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        jPanel3Layout.setVerticalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jButton1)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jButton2)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jButton3)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(jButton4))
        );

        jSplitPane2.setTopComponent(jPanel3);

        jPanel4.setBackground(new java.awt.Color(255, 255, 204));

        javax.swing.GroupLayout jPanel4Layout = new javax.swing.GroupLayout(jPanel4);
        jPanel4.setLayout(jPanel4Layout);
        jPanel4Layout.setHorizontalGroup(
            jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 112, Short.MAX_VALUE)
        );
        jPanel4Layout.setVerticalGroup(
            jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 334, Short.MAX_VALUE)
        );

        jSplitPane2.setRightComponent(jPanel4);

        jPanel1.add(jSplitPane2, java.awt.BorderLayout.CENTER);

        jSplitPane1.setLeftComponent(jPanel1);

        jPanel2.setBackground(new java.awt.Color(255, 255, 255));

        javax.swing.GroupLayout jPanel2Layout = new javax.swing.GroupLayout(jPanel2);
        jPanel2.setLayout(jPanel2Layout);
        jPanel2Layout.setHorizontalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 724, Short.MAX_VALUE)
        );
        jPanel2Layout.setVerticalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 455, Short.MAX_VALUE)
        );

        jSplitPane1.setRightComponent(jPanel2);

        getContentPane().add(jSplitPane1, java.awt.BorderLayout.CENTER);

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed
        boolean clearBefore = true;
        
        // Je≈õli sƒÖ ju≈º klocki, zapytaj co zrobiƒá
        if (!globaltabKlocki.isEmpty()) {
            String[] options = {"Nowe klocki", "Dodaj do istniejƒÖcych", "Wyczy≈õƒá wszystko"};
            String choice = (String) JOptionPane.showInputDialog(
                this,
                "Masz ju≈º " + globaltabKlocki.size() + " klock√≥w. Co chcesz zrobiƒá?",
                "Generowanie klock√≥w",
                JOptionPane.QUESTION_MESSAGE,
                null,
                options,
                options[0]
            );
            
            if (choice == null) return;
            
            if (choice.equals(options[2])) {
                globaltabKlocki.clear();
                jPanel2.repaint();
                return;
            }
            
            clearBefore = choice.equals(options[0]);
        }
        
        // Zapytaj o liczbƒô klock√≥w
        String countStr = JOptionPane.showInputDialog(
            this,
            "Podaj liczbƒô klock√≥w do wygenerowania (1-100):",
            "Liczba klock√≥w",
            JOptionPane.QUESTION_MESSAGE
        );
        
        if (countStr == null || countStr.trim().isEmpty()) return;
        
        int count;
        try {
            count = Integer.parseInt(countStr.trim());
            if (count < 1 || count > 100) {
                JOptionPane.showMessageDialog(this,
                    "Liczba klock√≥w musi byƒá z zakresu 1-100!",
                    "B≈ÇƒÖd",
                    JOptionPane.ERROR_MESSAGE);
                return;
            }
        } catch (NumberFormatException e) {
            JOptionPane.showMessageDialog(this,
                "Podaj poprawnƒÖ liczbƒô ca≈ÇkowitƒÖ!",
                "B≈ÇƒÖd",
                JOptionPane.ERROR_MESSAGE);
            return;
        }
        
        if (clearBefore) {
            globaltabKlocki.clear();
        }
        
        // Generuj klocki
        for (int i = 0; i < count; i++) {
            Klocek k = new Klocek(
                (int)(Math.random() * 100 + 100), 
                (int)(Math.random() * 100 + 100)
            );
            globaltabKlocki.add(k);
        }
        
        JOptionPane.showMessageDialog(this,
            "Wygenerowano " + count + " klock√≥w.\n≈ÅƒÖcznie: " + globaltabKlocki.size(),
            "Sukces",
            JOptionPane.INFORMATION_MESSAGE);
        
        jPanel2.repaint();
    }//GEN-LAST:event_jButton1ActionPerformed

    private void jButton2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton2ActionPerformed
        if (globaltabKlocki.isEmpty()) {
            JOptionPane.showMessageDialog(this,
                "Najpierw wygeneruj klocki!",
                "Brak klock√≥w",
                JOptionPane.WARNING_MESSAGE);
            return;
        }
        
        // Wy≈õwietl dialog wyboru algorytmu
        String[] algorithms = {
            "Algorytm podstawowy",
            "Brute Force (max 10 element√≥w)",
            "Zach≈Çanny z obracaniem",
            "Zach≈Çanny - sortowanie po powierzchni",
            "Zach≈Çanny - sortowanie po wysoko≈õci", 
            "Zach≈Çanny - sortowanie po szeroko≈õci",
            "Best-Fit",
            "üìä POR√ìWNAJ WSZYSTKIE ALGORYTMY"
        };
        
        String choice = (String) JOptionPane.showInputDialog(
            this,
            "Wybierz algorytm uk≈Çadania:\n(Liczba klock√≥w: " + globaltabKlocki.size() + ")",
            "Wyb√≥r algorytmu",
            JOptionPane.QUESTION_MESSAGE,
            null,
            algorithms,
            algorithms[0]
        );
        
        if (choice == null) return;
        
        if (choice.contains("POR√ìWNAJ")) {
            compareAllAlgorithms();
            return;
        }
        
        Tafla tafla = new Tafla(jPanel2.getWidth(), jPanel2.getHeight());
        
        try {
            if (choice.equals(algorithms[0])) {
                // Algorytm podstawowy z kontrolƒÖ granic
                long startTime = System.nanoTime();
                ArrayList<Klocek> arranged = new ArrayList<>();
                ArrayList<Klocek> copies = new ArrayList<>();
                for (Klocek k : globaltabKlocki) {
                    copies.add(k.copy());
                }
                int skipped = Algorytmy.podstawowyWithBounds(tafla, copies, arranged);
                long executionTime = System.nanoTime() - startTime;
                
                lastResult = new AlgorithmResult("Algorytm podstawowy");
                lastResult.setBlocks(arranged);
                lastResult.setSkippedBlocks(skipped);
                lastResult.setWasteArea(Algorytmy.calculateWaste(arranged));
                lastResult.setExecutionTimeNano(executionTime);
                globaltabKlocki = arranged;
            } else if (choice.equals(algorithms[1])) {
                // Brute Force
                if (globaltabKlocki.size() > 10) {
                    JOptionPane.showMessageDialog(this, 
                        "Brute Force dzia≈Ça tylko dla max 10 element√≥w!\nMasz: " + globaltabKlocki.size(),
                        "Zbyt du≈ºo element√≥w",
                        JOptionPane.WARNING_MESSAGE);
                    return;
                }
                lastResult = Algorytmy.bruteForcePacking(tafla, globaltabKlocki);
                globaltabKlocki = lastResult.getBlocks();
            } else if (choice.equals(algorithms[2])) {
                // Zach≈Çanny z obracaniem
                lastResult = Algorytmy.greedyWithRotation(tafla, globaltabKlocki);
                globaltabKlocki = lastResult.getBlocks();
            } else if (choice.equals(algorithms[3])) {
                // Sortowanie po powierzchni
                lastResult = Algorytmy.greedySortedByArea(tafla, globaltabKlocki);
                globaltabKlocki = lastResult.getBlocks();
            } else if (choice.equals(algorithms[4])) {
                // Sortowanie po wysoko≈õci
                lastResult = Algorytmy.greedySortedByHeight(tafla, globaltabKlocki);
                globaltabKlocki = lastResult.getBlocks();
            } else if (choice.equals(algorithms[5])) {
                // Sortowanie po szeroko≈õci
                lastResult = Algorytmy.greedySortedByWidth(tafla, globaltabKlocki);
                globaltabKlocki = lastResult.getBlocks();
            } else if (choice.equals(algorithms[6])) {
                // Best-Fit
                lastResult = Algorytmy.bestFitPacking(tafla, globaltabKlocki);
                globaltabKlocki = lastResult.getBlocks();
            }
            
            // Oblicz dodatkowe statystyki
            if (lastResult != null) {
                calculateStatistics(lastResult, jPanel2.getWidth(), jPanel2.getHeight());
                displayResults(lastResult);
            }
            
            jPanel2.repaint();
            
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, 
                "B≈ÇƒÖd podczas uk≈Çadania: " + e.getMessage(),
                "B≈ÇƒÖd",
                JOptionPane.ERROR_MESSAGE);
            logger.log(java.util.logging.Level.SEVERE, "B≈ÇƒÖd uk≈Çadania klock√≥w", e);
        }
    }//GEN-LAST:event_jButton2ActionPerformed
    
    private void compareAllAlgorithms() {
        int boardWidth = jPanel2.getWidth();
        int boardHeight = jPanel2.getHeight();
        Tafla tafla = new Tafla(boardWidth, boardHeight);
        ArrayList<AlgorithmResult> results = new ArrayList<>();
        
        // Zapisz oryginalne klocki
        ArrayList<Klocek> originalBlocks = new ArrayList<>();
        for (Klocek k : globaltabKlocki) {
            originalBlocks.add(k.copy());
        }
        
        boolean includeBruteForce = globaltabKlocki.size() <= 10;
        
        // 1. Algorytm podstawowy
        try {
            ArrayList<Klocek> copies = copyBlocks(originalBlocks);
            ArrayList<Klocek> arranged = new ArrayList<>();
            long start = System.nanoTime();
            int skipped = Algorytmy.podstawowyWithBounds(tafla, copies, arranged);
            long time = System.nanoTime() - start;
            
            AlgorithmResult r = new AlgorithmResult("Podstawowy");
            r.setBlocks(arranged);
            r.setSkippedBlocks(skipped);
            r.setExecutionTimeNano(time);
            calculateStatistics(r, boardWidth, boardHeight);
            results.add(r);
        } catch (Exception e) { /* skip */ }
        
        // 2. Brute Force (tylko dla <= 10 klock√≥w)
        if (includeBruteForce) {
            try {
                ArrayList<Klocek> copies = copyBlocks(originalBlocks);
                AlgorithmResult r = Algorytmy.bruteForcePacking(tafla, copies);
                r.setAlgorithmName("Brute Force");
                calculateStatistics(r, boardWidth, boardHeight);
                results.add(r);
            } catch (Exception e) { /* skip */ }
        }
        
        // 3. Zach≈Çanny z obracaniem
        try {
            ArrayList<Klocek> copies = copyBlocks(originalBlocks);
            AlgorithmResult r = Algorytmy.greedyWithRotation(tafla, copies);
            calculateStatistics(r, boardWidth, boardHeight);
            results.add(r);
        } catch (Exception e) { /* skip */ }
        
        // 4. Sortowanie po powierzchni
        try {
            ArrayList<Klocek> copies = copyBlocks(originalBlocks);
            AlgorithmResult r = Algorytmy.greedySortedByArea(tafla, copies);
            calculateStatistics(r, boardWidth, boardHeight);
            results.add(r);
        } catch (Exception e) { /* skip */ }
        
        // 5. Sortowanie po wysoko≈õci
        try {
            ArrayList<Klocek> copies = copyBlocks(originalBlocks);
            AlgorithmResult r = Algorytmy.greedySortedByHeight(tafla, copies);
            calculateStatistics(r, boardWidth, boardHeight);
            results.add(r);
        } catch (Exception e) { /* skip */ }
        
        // 6. Sortowanie po szeroko≈õci
        try {
            ArrayList<Klocek> copies = copyBlocks(originalBlocks);
            AlgorithmResult r = Algorytmy.greedySortedByWidth(tafla, copies);
            calculateStatistics(r, boardWidth, boardHeight);
            results.add(r);
        } catch (Exception e) { /* skip */ }
        
        // 7. Best-Fit
        try {
            ArrayList<Klocek> copies = copyBlocks(originalBlocks);
            AlgorithmResult r = Algorytmy.bestFitPacking(tafla, copies);
            calculateStatistics(r, boardWidth, boardHeight);
            results.add(r);
        } catch (Exception e) { /* skip */ }
        
        // Sortuj po efektywno≈õci (najlepsza pierwsza), przy remisie po czasie (kr√≥tszy lepszy)
        results.sort((a, b) -> {
            int effCompare = Double.compare(b.getEfficiency(), a.getEfficiency());
            if (effCompare != 0) {
                return effCompare;
            }
            // Przy tej samej efektywno≈õci - kr√≥tszy czas wygrywa
            return Double.compare(a.getExecutionTimeMicros(), b.getExecutionTimeMicros());
        });
        
        // Wy≈õwietl por√≥wnanie
        displayComparisonResults(results, originalBlocks.size(), includeBruteForce);
        
        // Ustaw klocki wg zwyciƒôskiego algorytmu
        if (!results.isEmpty()) {
            AlgorithmResult best = results.get(0);
            globaltabKlocki.clear();
            globaltabKlocki.addAll(best.getBlocks());
            jPanel2.repaint();
        }
    }
    
    private ArrayList<Klocek> copyBlocks(ArrayList<Klocek> source) {
        ArrayList<Klocek> copies = new ArrayList<>();
        for (Klocek k : source) {
            copies.add(k.copy());
        }
        return copies;
    }
    
    private void displayComparisonResults(ArrayList<AlgorithmResult> results, int blockCount, boolean includedBruteForce) {
        StringBuilder sb = new StringBuilder();
        sb.append(String.format("POR√ìWNANIE ALGORYTM√ìW (klock√≥w: %d)%n", blockCount));
        sb.append("‚ïê".repeat(60)).append("\n\n");
        
        sb.append(String.format("%-22s %10s %10s %12s%n", "ALGORYTM", "EFEKT. %", "ODPAD", "CZAS"));
        sb.append("‚îÄ".repeat(60)).append("\n");
        
        AlgorithmResult best = results.isEmpty() ? null : results.get(0);
        
        for (int i = 0; i < results.size(); i++) {
            AlgorithmResult r = results.get(i);
            String medal = switch(i) {
                case 0 -> "ü•á ";
                case 1 -> "ü•à ";
                case 2 -> "ü•â ";
                default -> "   ";
            };
            
            // Skr√≥ƒá d≈Çugie nazwy do wy≈õwietlenia w tabeli
            String shortName = shortenAlgorithmName(r.getAlgorithmName());
            
            sb.append(String.format("%s%-19s %9.2f%% %10.0f %12s%n",
                medal,
                shortName,
                r.getEfficiency(),
                r.getWasteArea(),
                r.getFormattedTime()
            ));
        }
        
        sb.append("‚îÄ".repeat(60)).append("\n");
        
        if (!includedBruteForce) {
            sb.append("\n‚ö†Ô∏è Brute Force pominiƒôty (>10 klock√≥w)\n");
        }
        
        if (best != null) {
            sb.append(String.format("%nüèÜ NAJLEPSZY: %s (%.2f%%)%n",
                best.getAlgorithmName(), best.getEfficiency()));
        }
        
        sb.append("\nCzy zapisaƒá wszystkie wyniki do bazy danych?");
        
        JTextArea textArea = new JTextArea(sb.toString());
        textArea.setEditable(false);
        textArea.setFont(new java.awt.Font("Monospaced", java.awt.Font.PLAIN, 12));
        javax.swing.JScrollPane scrollPane = new javax.swing.JScrollPane(textArea);
        scrollPane.setPreferredSize(new java.awt.Dimension(550, 350));
        
        int option = JOptionPane.showConfirmDialog(
            this, 
            scrollPane,
            "Por√≥wnanie algorytm√≥w",
            JOptionPane.YES_NO_OPTION
        );
        
        if (option == JOptionPane.YES_OPTION && dbManager != null) {
            int saved = 0;
            for (AlgorithmResult r : results) {
                try {
                    dbManager.saveResult(r);
                    saved++;
                } catch (SQLException e) { /* skip */ }
            }
            JOptionPane.showMessageDialog(this,
                "Zapisano " + saved + " wynik√≥w do bazy danych.",
                "Sukces",
                JOptionPane.INFORMATION_MESSAGE);
        }
    }
    
    private String shortenAlgorithmName(String name) {
        return switch(name) {
            case "Zach≈Çanny z obracaniem" -> "Zach≈Çanny + rotacja";
            case "Zach≈Çanny - sortowanie po powierzchni" -> "Sort. powierzchnia";
            case "Zach≈Çanny - sortowanie po wysoko≈õci" -> "Sort. wysoko≈õƒá";
            case "Zach≈Çanny - sortowanie po szeroko≈õci" -> "Sort. szeroko≈õƒá";
            default -> name;
        };
    }
    
    private void calculateStatistics(AlgorithmResult result, int boardWidth, int boardHeight) {
        double usedArea = 0;
        int fittedBlocks = 0;
        int outsideBlocks = 0;
        
        for (Klocek k : result.getBlocks()) {
            // Sprawd≈∫ czy klocek mie≈õci siƒô w granicach tafli
            int kRight = k.getPosx() + k.getWidth();
            int kBottom = k.getPosy() + k.getHeight();
            
            if (k.getPosx() >= 0 && k.getPosy() >= 0 && 
                kRight <= boardWidth && kBottom <= boardHeight) {
                // Klocek w pe≈Çni mie≈õci siƒô w tafli
                usedArea += k.getWidth() * k.getHeight();
                fittedBlocks++;
            } else {
                // Klocek wychodzi poza taflƒô - licz tylko czƒô≈õƒá wewnƒÖtrz
                int visibleX = Math.max(0, Math.min(kRight, boardWidth) - Math.max(0, k.getPosx()));
                int visibleY = Math.max(0, Math.min(kBottom, boardHeight) - Math.max(0, k.getPosy()));
                usedArea += visibleX * visibleY;
                outsideBlocks++;
            }
        }
        
        // Sta≈Çy rozmiar tafli jako total_area
        double totalArea = (double) boardWidth * boardHeight;
        double efficiency = (usedArea / totalArea) * 100.0;
        
        // Odpad = powierzchnia tafli - powierzchnia faktycznie pokryta przez klocki
        double wasteArea = totalArea - usedArea;
        
        result.setUsedArea(usedArea);
        result.setTotalArea(totalArea);
        result.setWasteArea(wasteArea);
        result.setEfficiency(efficiency);
        // Aktualizuj skippedBlocks: dotychczasowe + te kt√≥re wysz≈Çy poza taflƒô
        result.setSkippedBlocks(result.getSkippedBlocks() + outsideBlocks);
        // Ustaw liczbƒô blok√≥w tylko na te kt√≥re w pe≈Çni siƒô zmie≈õci≈Çy
        result.setBlockCount(fittedBlocks);
    }
    
    private void displayResults(AlgorithmResult result) {
        String skippedInfo = "";
        if (result.getSkippedBlocks() > 0) {
            skippedInfo = String.format("\nNieumieszczone klocki: %d", result.getSkippedBlocks());
        }
        
        String message = String.format("""
            === WYNIKI ===
            
            Algorytm: %s
            Czas wykonania: %s
            Liczba klock√≥w: %d%s
            
            Powierzchnia u≈ºyta: %.0f
            Powierzchnia ca≈Çkowita: %.0f
            Odpad: %.2f
            Efektywno≈õƒá: %.2f%%
            
            Czy zapisaƒá do bazy danych?""",
            result.getAlgorithmName(),
            result.getFormattedTime(),
            result.getBlocks().size(),
            skippedInfo,
            result.getUsedArea(),
            result.getTotalArea(),
            result.getWasteArea(),
            result.getEfficiency()
        );
        
        int option = JOptionPane.showConfirmDialog(
            this, 
            message,
            "Wyniki algorytmu",
            JOptionPane.YES_NO_OPTION
        );
        
        if (option == JOptionPane.YES_OPTION) {
            saveResultToDatabase(result);
        }
    }
    
    private void saveResultToDatabase(AlgorithmResult result) {
        if (dbManager == null) {
            JOptionPane.showMessageDialog(this,
                "Brak po≈ÇƒÖczenia z bazƒÖ danych!",
                "B≈ÇƒÖd",
                JOptionPane.ERROR_MESSAGE);
            return;
        }
        
        try {
            dbManager.saveResult(result);
            JOptionPane.showMessageDialog(this,
                "Wyniki zapisane do bazy danych!",
                "Sukces",
                JOptionPane.INFORMATION_MESSAGE);
        } catch (SQLException e) {
            JOptionPane.showMessageDialog(this,
                "B≈ÇƒÖd zapisu do bazy: " + e.getMessage(),
                "B≈ÇƒÖd",
                JOptionPane.ERROR_MESSAGE);
        }
    }

    private void jButton3ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton3ActionPerformed
        String[] options = {
            "Zapisz klocki do pliku",
            "Poka≈º ostatnie wyniki z BD",
            "Poka≈º statystyki algorytm√≥w"
        };
        
        String choice = (String) JOptionPane.showInputDialog(
            this,
            "Wybierz opcjƒô:",
            "Opcje zapisu/odczytu",
            JOptionPane.QUESTION_MESSAGE,
            null,
            options,
            options[0]
        );
        
        if (choice == null) return;
        
        if (choice.equals(options[0])) {
            // Zapis do pliku
            try (FileOutputStream p1 = new FileOutputStream("dane.txt");
                 ObjectOutputStream s = new ObjectOutputStream(p1)) {
                s.writeObject(globaltabKlocki);
                JOptionPane.showMessageDialog(this, "Klocki zapisane do pliku dane.txt");
            } catch (IOException ex) {
                logger.log(java.util.logging.Level.SEVERE, "B≈ÇƒÖd zapisu do pliku", ex);
                JOptionPane.showMessageDialog(this, 
                    "B≈ÇƒÖd zapisu do pliku: " + ex.getMessage(),
                    "B≈ÇƒÖd",
                    JOptionPane.ERROR_MESSAGE);
            }
        } else if (choice.equals(options[1])) {
            // Ostatnie wyniki z BD
            showDatabaseResults();
        } else if (choice.equals(options[2])) {
            // Statystyki
            showAlgorithmStatistics();
        }
    }//GEN-LAST:event_jButton3ActionPerformed
    
    private void showDatabaseResults() {
        if (dbManager == null) {
            JOptionPane.showMessageDialog(this,
                "Brak po≈ÇƒÖczenia z bazƒÖ danych!",
                "B≈ÇƒÖd",
                JOptionPane.ERROR_MESSAGE);
            return;
        }
        
        try {
            String results = dbManager.getLastResults(10);
            JTextArea textArea = new JTextArea(results);
            textArea.setEditable(false);
            textArea.setRows(20);
            textArea.setColumns(50);
            javax.swing.JScrollPane scrollPane = new javax.swing.JScrollPane(textArea);
            
            JOptionPane.showMessageDialog(this,
                scrollPane,
                "Ostatnie 10 wynik√≥w",
                JOptionPane.INFORMATION_MESSAGE);
        } catch (SQLException e) {
            JOptionPane.showMessageDialog(this,
                "B≈ÇƒÖd odczytu z bazy: " + e.getMessage(),
                "B≈ÇƒÖd",
                JOptionPane.ERROR_MESSAGE);
        }
    }
    
    private void showAlgorithmStatistics() {
        if (dbManager == null) {
            JOptionPane.showMessageDialog(this,
                "Brak po≈ÇƒÖczenia z bazƒÖ danych!",
                "B≈ÇƒÖd",
                JOptionPane.ERROR_MESSAGE);
            return;
        }
        
        try {
            String stats = dbManager.getAlgorithmStatistics();
            JTextArea textArea = new JTextArea(stats);
            textArea.setEditable(false);
            textArea.setRows(20);
            textArea.setColumns(50);
            javax.swing.JScrollPane scrollPane = new javax.swing.JScrollPane(textArea);
            
            JOptionPane.showMessageDialog(this,
                scrollPane,
                "Statystyki algorytm√≥w",
                JOptionPane.INFORMATION_MESSAGE);
        } catch (SQLException e) {
            JOptionPane.showMessageDialog(this,
                "B≈ÇƒÖd odczytu statystyk: " + e.getMessage(),
                "B≈ÇƒÖd",
                JOptionPane.ERROR_MESSAGE);
        }
    }

    @SuppressWarnings("unchecked")
    private void jButton4ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton4ActionPerformed
        try (FileInputStream p1 = new FileInputStream("dane.txt");
             ObjectInputStream s = new ObjectInputStream(p1)) {
            globaltabKlocki = (ArrayList<Klocek>) s.readObject();
            jPanel2.repaint();
            JOptionPane.showMessageDialog(this, 
                "Wczytano " + globaltabKlocki.size() + " klock√≥w z pliku",
                "Sukces",
                JOptionPane.INFORMATION_MESSAGE);
        } catch (FileNotFoundException ex) {
            JOptionPane.showMessageDialog(this, 
                "Nie znaleziono pliku dane.txt",
                "B≈ÇƒÖd",
                JOptionPane.ERROR_MESSAGE);
        } catch (IOException | ClassNotFoundException ex) {
            logger.log(java.util.logging.Level.SEVERE, "B≈ÇƒÖd odczytu pliku", ex);
            JOptionPane.showMessageDialog(this, 
                "B≈ÇƒÖd odczytu pliku: " + ex.getMessage(),
                "B≈ÇƒÖd",
                JOptionPane.ERROR_MESSAGE);
        }
    }//GEN-LAST:event_jButton4ActionPerformed

    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        /* Set the Nimbus look and feel */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        /* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
         * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
         */
        try {
            for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
                if ("Nimbus".equals(info.getName())) {
                    javax.swing.UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (ReflectiveOperationException | javax.swing.UnsupportedLookAndFeelException ex) {
            logger.log(java.util.logging.Level.SEVERE, null, ex);
        }
        //</editor-fold>

        /* Create and display the form */
        java.awt.EventQueue.invokeLater(() -> {
            GUI gui = new GUI();
            gui.setVisible(true);
            
            // Dodaj WindowListener do zamykania po≈ÇƒÖczenia z BD
            gui.addWindowListener(new java.awt.event.WindowAdapter() {
                @Override
                public void windowClosing(java.awt.event.WindowEvent windowEvent) {
                    if (gui.dbManager != null) {
                        gui.dbManager.close();
                    }
                }
            });
        });
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton jButton1;
    private javax.swing.JButton jButton2;
    private javax.swing.JButton jButton3;
    private javax.swing.JButton jButton4;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JSplitPane jSplitPane1;
    private javax.swing.JSplitPane jSplitPane2;
    // End of variables declaration//GEN-END:variables
}
